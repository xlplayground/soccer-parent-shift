<script>
// Replace with your new Google Apps Script web app URL
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyfCBOtlI0Cf2zcc4ex5b4PqbfzHib-ZKpjMoXu0dwDRCcuy0Pu3LomU9_Ypr98tmJuzQ/exec';

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('signupForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Form submission intercepted');

            const name = document.getElementById('name').value;
            const date = document.getElementById('date').value;
            console.log(`Attempting to sign up ${name} for ${date}`);

            try {
                const result = await addSignup(date, name);
                console.log('Signup result:', result);

                if (result === 'Success') {
                    alert(`Thank you for volunteering, ${name}! You have been successfully signed up.`);
                    await updateScheduleDisplay();
                    this.reset();
                } else if (result === 'Date full') {
                    alert('We appreciate your willingness to help, but this date already has two volunteers. Please choose another date.');
                } else {
                    alert('An error occurred. Please try again or contact the coordinator.');
                }
            } catch (error) {
                console.error('Error during signup:', error);
                alert('An error occurred. Please try again or contact the coordinator.');
            }
        });
    } else {
        console.error('Signup form not found');
    }

    updateScheduleDisplay();
});

async function getSchedule() {
    try {
        console.log('Fetching schedule...');
        const response = await fetch(`${SCRIPT_URL}?action=getSchedule`);
        console.log('Schedule response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        console.log('Schedule data received:', data);
        return data;
    } catch (error) {
        console.error('Error fetching schedule:', error);
        alert(`Unable to fetch the current schedule. Error: ${error.message}`);
        return {};
    }
}

async function addSignup(date, name) {
    console.log(`Sending signup request for ${name} on ${date}`);
    const response = await fetch(`${SCRIPT_URL}?action=addSignup&date=${date}&name=${name}`);
    console.log('Signup response status:', response.status);
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    console.log('Signup response data:', data);
    return data.result;
}

async function updateScheduleDisplay() {
    const schedule = await getSchedule();
    const scheduleBody = document.getElementById('scheduleBody');
    if (scheduleBody) {
        scheduleBody.innerHTML = '';
        for (const [date, parents] of Object.entries(schedule)) {
            const row = document.createElement('tr');
            const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>${parents[0] || '-'}</td>
                <td>${parents[1] || '-'}</td>
            `;
            scheduleBody.appendChild(row);
        }
    } else {
        console.error('Schedule body element not found');
    }
}
</script>
